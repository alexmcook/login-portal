services:
  postgres:
    image: postgres:18-alpine
    container_name: login-portal-postgres
    restart: unless-stopped
    env_file: .env
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_DB=${POSTGRES_DB:-login-portal}
      - PGDATA_QUIET=false
      - POSTGRES_PASSWORD_FILE=/run/secrets/POSTGRES_PASSWORD
      - POSTGRES_INITDB_ARGS=--auth-host=scram-sha-256 --auth-local=scram-sha-256
    secrets:
      - POSTGRES_PASSWORD
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:8-alpine
    container_name: login-portal-redis
    restart: unless-stopped
    env_file: .env
    secrets:
      - REDIS_PASSWORD
    command: ["sh", "-c", "redis-server --requirepass $$(cat /run/secrets/REDIS_PASSWORD)"]
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -a $$(cat /run/secrets/REDIS_PASSWORD) ping | grep PONG"]
      interval: 10s
      timeout: 5s
      retries: 5

  api:
    image: ghcr.io/${GITHUB_REPOSITORY_OWNER:-dev}/login-portal-api:latest
    build:
      context: .
      dockerfile: Dockerfile
    container_name: login-portal-api
    restart: unless-stopped
    env_file: .env
    environment:
      - SERVER_PORT=${SERVER_PORT:-3000}
      - POSTGRES_HOST=${POSTGRES_HOST:-postgres}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_DB=${POSTGRES_DB:-login-portal}
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
    secrets:
      - POSTGRES_PASSWORD
      - REDIS_PASSWORD
      - ACTIVATION_SECRET
      - PASSWORD_RESET_SECRET
      - JWT_SECRET
      - APPROVED_EMAIL
    ports:
      - "${SERVER_PORT:-3000}:3000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  client:
    image: ghcr.io/${GITHUB_REPOSITORY_OWNER:-dev}/login-portal-client:latest
    build:
      context: client
      dockerfile: Dockerfile
    container_name: login-portal-client
    restart: unless-stopped
    env_file: .env
    ports:
      - "${CLIENT_PORT:-5173}:5173"
    depends_on:
      - api

volumes:
  postgres_data:

secrets:
  POSTGRES_PASSWORD:
    file: .secrets/POSTGRES_PASSWORD
  REDIS_PASSWORD:
    file: .secrets/REDIS_PASSWORD
  ACTIVATION_SECRET:
    file: .secrets/ACTIVATION_SECRET
  PASSWORD_RESET_SECRET:
    file: .secrets/PASSWORD_RESET_SECRET
  JWT_SECRET:
    file: .secrets/JWT_SECRET
  APPROVED_EMAIL:
    file: .secrets/APPROVED_EMAIL

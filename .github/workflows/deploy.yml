name: Build and Deploy

on:
  workflow_dispatch:
  # push:
  #   branches: [ main ]

permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    name: Build and push image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/login-portal:latest
            ghcr.io/${{ github.repository_owner }}/login-portal:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: production
    steps:
      - name: Checkout (for reference)
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -euo pipefail
            DEPLOY_DIR="${{ secrets.DEPLOY_DIR }}"
            if [ -z "$DEPLOY_DIR" ]; then
              DEPLOY_DIR="/home/${{ secrets.DEPLOY_USER }}/login-portal"
            fi
            echo "Using deploy dir: $DEPLOY_DIR"
            mkdir -p "$DEPLOY_DIR/.secrets"

            # write secret files expected by src/config.ts
            cat > "$DEPLOY_DIR/.secrets/POSTGRES_PASSWORD" <<'POSTGRES_PASSWORD' ${{ secrets.POSTGRES_PASSWORD }}
            POSTGRES_PASSWORD chmod 0400 "$DEPLOY_DIR/.secrets/POSTGRES_PASSWORD" || true

            cat > "$DEPLOY_DIR/.secrets/REDIS_PASSWORD" <<'REDIS_PASSWORD' ${{ secrets.REDIS_PASSWORD }}
            REDIS_PASSWORD chmod 0400 "$DEPLOY_DIR/.secrets/REDIS_PASSWORD" || true

            cat > "$DEPLOY_DIR/.secrets/ACTIVATION_SECRET" <<'ACTIVATION_SECRET' ${{ secrets.ACTIVATION_SECRET }}
            ACTIVATION_SECRET chmod 0400 "$DEPLOY_DIR/.secrets/ACTIVATION_SECRET" || true

            cat > "$DEPLOY_DIR/.secrets/PASSWORD_RESET_SECRET" <<'PASSWORD_RESET_SECRET' ${{ secrets.PASSWORD_RESET_SECRET }}
            PASSWORD_RESET_SECRET chmod 0400 "$DEPLOY_DIR/.secrets/PASSWORD_RESET_SECRET" || true

            cat > "$DEPLOY_DIR/.secrets/JWT_SECRET" <<'JWT_SECRET' ${{ secrets.JWT_SECRET }}
            JWT_SECRET chmod 0400 "$DEPLOY_DIR/.secrets/JWT_SECRET" || true

            cat > "$DEPLOY_DIR/.secrets/APPROVED_EMAIL" <<'APPROVED_EMAIL' ${{ secrets.APPROVED_EMAIL }}
            APPROVED_EMAIL chmod 0400 "$DEPLOY_DIR/.secrets/APPROVED_EMAIL" || true

            # Ensure repository present
            if [ -d "$DEPLOY_DIR/.git" ]; then
              echo "Repo exists, pulling latest"
              cd "$DEPLOY_DIR" && git fetch --all && git reset --hard origin/main || true
            else
              echo "Cloning repo into $DEPLOY_DIR"
              git clone --depth 1 https://github.com/${{ github.repository }} "$DEPLOY_DIR"
            fi

            cd "$DEPLOY_DIR"

            # Pull latest image and deploy with docker compose
            docker pull ghcr.io/${{ github.repository_owner }}/login-portal:latest || true

            # Use docker compose if present
            if [ -f docker-compose.yml ] || [ -f docker-compose.yaml ]; then
              docker compose pull || true
              docker compose up -d --build
            else
              # Fallback: run container directly (mount secrets dir into container as in compose)
              docker stop login-portal-api || true
              docker rm login-portal-api || true
              docker run -d --name login-portal-api \
                -p 3000:3000 \
                -v "$DEPLOY_DIR/.secrets":/run/secrets:ro \
                ghcr.io/${{ github.repository_owner }}/login-portal:latest
            fi

            # Optionally run migrations explicitly once
            if command -v docker > /dev/null; then
              if [ -f docker-compose.yml ] || [ -f docker-compose.yaml ]; then
                docker compose run --rm api npm run migrate:up || true
              else
                docker exec -i login-portal-api npm run migrate:up || true
              fi
            fi

            echo "Deploy complete"
